C51 COMPILER V9.51   APP                                                                   11/20/2013 20:14:53 PAGE 1   


C51 COMPILER V9.51, COMPILATION OF MODULE APP
OBJECT MODULE PLACED IN .\Output\app.obj
COMPILER INVOKED BY: C:\Program Files (x86)\Keil\C51\BIN\C51.EXE Code\app.c LARGE BROWSE DEBUG OBJECTEXTEND PRINT(.\Outp
                    -ut\app.lst) TABS(2) OBJECT(.\Output\app.obj)

line level    source

   1          #include "app.h"
   2          #include "stc15.h"
   3          #include "system.h"
   4          #include <stdio.h>
   5          
   6          uint8 pwmTime[8] = {0, 0, 0, 0, 0, 0, 0, 0};   // PWM 计时
   7          uint8 ledMode = 0;      // LED 模式
   8          uint16 ledTime[8] = {0, 0, 0, 0, 0, 0, 0, 0};    // LED 时间，0 为未启动
   9          int8 code ledSensitivityAdjust[8] = {0, 0, -20, -20, 0, 0, 0, -20};  //灵敏度校正
  10          uint16 blinkCounter[8] = {0, 0, 0, 0, 0, 0, 0, 0};   // LED闪烁计时器
  11          bit sensitivityMode = 0;  // 灵敏度模式， 0 - 夜晚， 1 - 白天
  12          uint8 sensitivity = SENSITIVITY_NIGHT;   // 灵敏度
  13          
  14          void init()
  15          {
  16   1        initADC();
  17   1        
  18   1        KEY = !KEY_PRESSED;
  19   1        P2 = 0x00;
  20   1        P2M0 = 0xff;
  21   1        P2M1 = 0x00;
  22   1        
  23   1        // 初始化 LED 计时器（定时器 0）
  24   1        AUXR |= 0x80;  // 定时器 0：1T 模式
  25   1        TMOD = 0x03;   // 定时器 0 模式 3
  26   1        TL0 = T20MS;   // 装入时间：20ms
  27   1        TH0 = T20MS >> 8;
  28   1        TR0 = 1;       // 开始计时
  29   1        ET0 = 1;       // 使能定时器 0 在模式 3 下的中断
  30   1      }
  31          
  32          // 启动 LED
  33          void lightUp(pin)
  34          {
  35   1        uint8 result;
  36   1        P1 = 0x01 << pin;
  37   1        result = getADCResult(pin);
  38   1        if (result > (sensitivity + ledSensitivityAdjust[pin]))
  39   1        {
  40   2          ledTime[pin] = 1;
  41   2        }
  42   1      }
  43          
  44          // LED 的 PWM 控制程序
  45          void ledPWM(uint8 pin, uint8 brightness)
  46          {
  47   1        pwmTime[pin] = pwmTime[pin] + 1;
  48   1        if(pwmTime[pin] >= 20)
  49   1        {
  50   2          pwmTime[pin] = 0;
  51   2        }
  52   1        if(pwmTime[pin] <= brightness)
  53   1        {
  54   2          P2 |= 0x01 << pin;
C51 COMPILER V9.51   APP                                                                   11/20/2013 20:14:53 PAGE 2   

  55   2        }
  56   1        if(pwmTime[pin] > brightness)
  57   1        {
  58   2          P2 &= 0xfe << pin;
  59   2        }
  60   1      }
  61          
  62          // LED 慢速闪烁
  63          void ledBlink1(pin)
  64          {
  65   1        blinkCounter[pin] = blinkCounter[pin] + 1;
  66   1        if(blinkCounter[pin] == 200)
  67   1        {
  68   2          P2 |= 0x01 << pin;
  69   2        }
  70   1        if(blinkCounter[pin] == 224)
  71   1        {
  72   2          P2 &= 0xfe << pin;
  73   2        }
  74   1        if(blinkCounter[pin] >= 400)
  75   1        {
  76   2          blinkCounter[pin] = 0;
  77   2        }
  78   1      }
  79          
  80          // LED 快速闪烁
  81          void ledBlink2(pin)
  82          {
  83   1        blinkCounter[pin] = blinkCounter[pin] + 1;
  84   1        if(blinkCounter[pin] == 100)
  85   1        {
  86   2          P2 |= 0x01 << pin;
  87   2        }
  88   1        if(blinkCounter[pin] == 124)
  89   1        {
  90   2          P2 &= 0xfe << pin;
  91   2        }
  92   1        if(blinkCounter[pin] >= 200)
  93   1        {
  94   2          blinkCounter[pin] = 0;
  95   2        }
  96   1      }
  97          
  98            
  99          // LED 处理
 100          // 到达指定的时间调节 LED 亮度
 101          void ledProcess(uint8 pin)
 102          {
*** WARNING C235 IN LINE 102 OF Code\app.c: parameter 1: different types
 103   1        switch (ledMode)
 104   1        {   
 105   2          
 106   2        case 0 :
 107   2            // 渐变
 108   2            if(ledTime[pin] != 0)
 109   2            {
 110   3              ledPWM(pin, (260-ledTime[pin]) / 13);
 111   3            }
 112   2            break;
 113   2            
 114   2        case 1:
 115   2            // 快速闪烁
C51 COMPILER V9.51   APP                                                                   11/20/2013 20:14:53 PAGE 3   

 116   2            if(ledTime[pin] != 0)
 117   2            {
 118   3              ledBlink1(pin);
 119   3            }
 120   2            break;
 121   2            
 122   2        case 2:
 123   2            // 闪烁
 124   2            if(ledTime[pin] != 0)
 125   2            {
 126   3              ledBlink2(pin);
 127   3            }
 128   2            break;
 129   2      
 130   2        case 3:
 131   2            // 手放上去灯灭
 132   2            if(ledTime[pin] == 0)
 133   2            {
 134   3              P2 |= 0x01 << pin;
 135   3            }
 136   2            else
 137   2            {
 138   3              P2 &= 0xfe << pin;
 139   3            }
 140   2            break;
 141   2        }
 142   1      }
 143          
 144          // 按键处理
 145          void keyProcess()
 146          {
 147   1        static uint16 keyTime = 0;
 148   1        static bit keyLock = 0;
 149   1        if(KEY == KEY_PRESSED)
 150   1        {
 151   2          keyTime++;
 152   2          if(keyTime >= 1000 && keyLock == 0)
 153   2          {
 154   3            ledMode++;
 155   3            if(ledMode > LED_MODE_NUM - 1)
 156   3            {
 157   4              ledMode = 0;
 158   4              
 159   4              // 设置灵敏度
 160   4              sensitivityMode = ~sensitivityMode;
 161   4              if (sensitivityMode == 1)
 162   4              {
 163   5                sensitivity = SENSITIVITY_DAY;
 164   5              }
 165   4              else
 166   4              {
 167   5                sensitivity = SENSITIVITY_NIGHT;
 168   5              }
 169   4              
 170   4              P2 = 0x00;
 171   4            }
 172   3            keyLock = 1;
 173   3          }
 174   2        }
 175   1        if(keyTime > 2000)
 176   1        {
 177   2          if(KEY != KEY_PRESSED)
C51 COMPILER V9.51   APP                                                                   11/20/2013 20:14:53 PAGE 4   

 178   2          {
 179   3            keyTime = 0;
 180   3            keyLock = 0;
 181   3          }
 182   2        }
 183   1      }
 184            
 185          void ledTimeUpdate() interrupt 1 using 1
 186          {
 187   1        uint8 i;
 188   1        for(i = 0; i <= 7; i++)
 189   1        {
 190   2          if(ledTime[i] != 0)
 191   2          {
 192   3            ledTime[i] = ledTime[i] + 1;
 193   3            if(ledTime[i] >= 260)
 194   3            {
 195   4              ledTime[i] = 0;
 196   4              P2 &= 0xfe << i;
 197   4            }
 198   3          }
 199   2        }
 200   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    885    ----
   CONSTANT SIZE    =     16    ----
   XDATA SIZE       =     44       3
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      2    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  1 WARNING(S),  0 ERROR(S)
