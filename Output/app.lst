C51 COMPILER V9.00   APP                                                                   11/10/2013 13:25:21 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE APP
OBJECT MODULE PLACED IN .\Output\app.obj
COMPILER INVOKED BY: D:\Program Files\kell\C51\BIN\C51.EXE Code\app.c LARGE BROWSE DEBUG OBJECTEXTEND PRINT(.\Output\app
                    -.lst) OBJECT(.\Output\app.obj)

line level    source

   1          #include "app.h"
   2          #include "stc15.h"
   3          #include "system.h"
   4          #include <stdio.h>
   5          
   6          uint8 pwmTime[8] = {0, 0, 0, 0, 0, 0, 0, 0};   // PWM 计时
   7          uint8 ledMode = 0;      // LED 模式
   8          uint16 ledTime[8] = {0, 0, 0, 0, 0, 0, 0, 0};    // LED 时间，0 为未启动
   9          
  10          uint16 blinkCounter[8] = {0, 0, 0, 0, 0, 0, 0, 0};   
  11          
  12          void init()
  13          {
  14   1              initUart();
  15   1              initADC();
  16   1              
  17   1              KEY = !KEY_PRESSED;
  18   1              P2 = 0x00;
  19   1              P2M0 = 0xff;
  20   1              P2M1 = 0x00;
  21   1              
  22   1              // 初始化 LED 计时器（定时器 0）
  23   1              AUXR |= 0x80;  // 定时器 0：1T 模式
  24   1              TMOD = 0x03;   // 定时器 0 模式 3
  25   1        TL0 = T20MS;   // 装入时间：20ms
  26   1              TH0 = T20MS >> 8;
  27   1              TR0 = 1;       // 开始计时
  28   1              ET0 = 1;       // 使能定时器 0 在模式 3 下的中断
  29   1              
  30   1              
  31   1              printf("LED Interactive Desk\nby xiao3d and Blanboom\nhttp://blanboom.org\n");
  32   1      }
  33          
  34          // 启动 LED
  35          void lightUp(pin)
  36          {
  37   1              uint8 result;
  38   1              P1 = 0x01 << pin;
  39   1              result = getADCResult(pin);
  40   1              if (result > 60)
  41   1              {
  42   2                      ledTime[pin] = 1;
  43   2              }
  44   1      }
  45          
  46          // LED 的 PWM 控制程序
  47          void ledPWM(uint8 pin, uint8 brightness)
  48          {
  49   1              pwmTime[pin] = pwmTime[pin] + 1;
  50   1              if(pwmTime[pin] >= 20)
  51   1              {
  52   2                      pwmTime[pin] = 0;
  53   2              }
  54   1              if(pwmTime[pin] <= brightness)
C51 COMPILER V9.00   APP                                                                   11/10/2013 13:25:21 PAGE 2   

  55   1              {
  56   2                      P2 |= 0x01 << pin;
  57   2              }
  58   1              if(pwmTime[pin] > brightness)
  59   1              {
  60   2                      P2 &= 0xfe << pin;
  61   2              }
  62   1      }
  63          
  64          // LED 闪烁
  65          void ledBlink1(pin)
  66          {
  67   1              blinkCounter[pin] = blinkCounter[pin] + 1;
  68   1              if(blinkCounter[pin] == 200)
  69   1              {
  70   2                      P2 |= 0x01 << pin;
  71   2              }
  72   1              if(blinkCounter[pin] == 224)
  73   1              {
  74   2                      P2 &= 0xfe << pin;
  75   2              }
  76   1              if(blinkCounter[pin] >= 400)
  77   1              {
  78   2                      blinkCounter[pin] = 0;
  79   2              }
  80   1      }
  81          // LED 闪烁
  82          void ledBlink2(pin)
  83          {
  84   1              blinkCounter[pin] = blinkCounter[pin] + 1;
  85   1              if(blinkCounter[pin] == 100)
  86   1              {
  87   2                      P2 |= 0x01 << pin;
  88   2              }
  89   1              if(blinkCounter[pin] == 124)
  90   1              {
  91   2                      P2 &= 0xfe << pin;
  92   2              }
  93   1              if(blinkCounter[pin] >= 200)
  94   1              {
  95   2                      blinkCounter[pin] = 0;
  96   2              }
  97   1      }
  98          // LED 闪烁
  99          void ledBlink3(pin)
 100          {
 101   1              blinkCounter[pin] = blinkCounter[pin] + 1;
 102   1              if(blinkCounter[pin] == 400)
 103   1              {
 104   2                      P2 |= 0x01 << pin;
 105   2              }
 106   1              if(blinkCounter[pin] == 450)
 107   1              {
 108   2                      P2 &= 0xfe << pin;
 109   2              }
 110   1              if(blinkCounter[pin] >= 800)
 111   1              {
 112   2                      blinkCounter[pin] = 0;
 113   2              }
 114   1      }
 115                  
 116          // LED 处理
C51 COMPILER V9.00   APP                                                                   11/10/2013 13:25:21 PAGE 3   

 117          // 到达指定的时间调节 LED 亮度
 118          void ledProcess(uint8 pin)
 119          {
*** WARNING C235 IN LINE 119 OF CODE\APP.C: parameter 1: different types
 120   1              switch (ledMode)
 121   1              {               
 122   2                      
 123   2              case 0 :
 124   2                              // 渐变
 125   2                              if(ledTime[pin] != 0)
 126   2                              {
 127   3                                      ledPWM(pin, (260-ledTime[pin]) / 13);
 128   3                              }
 129   2                              break;
 130   2                              
 131   2              case 1:
 132   2                              // 灯亮一定时间后灭
 133   2                              if(ledTime[pin] != 0)
 134   2                              {
 135   3                                      P2 |= 0x01 << pin;
 136   3                              }
 137   2                              break;
 138   2                              
 139   2              case 2:
 140   2                              // 快速闪烁
 141   2                              if(ledTime[pin] != 0)
 142   2                              {
 143   3                                      ledBlink1(pin);
 144   3                              }
 145   2                              break;
 146   2              case 3:
 147   2                              // 闪烁
 148   2                              if(ledTime[pin] != 0)
 149   2                              {
 150   3                                      ledBlink2(pin);
 151   3                              }
 152   2                              break;
 153   2              case 4:
 154   2                              // 闪烁
 155   2                              if(ledTime[pin] != 0)
 156   2                              {
 157   3                                      ledBlink3(pin);
 158   3                              }
 159   2                              break;
 160   2                              
 161   2              case 5:
 162   2                              // 手放上去灯灭
 163   2                          if(ledTime[pin] == 0)
 164   2                              {
 165   3                                      P2 |= 0x01 << pin;
 166   3                              }
 167   2                              else
 168   2                              {
 169   3                                      P2 &= 0xfe << pin;
 170   3                              }
 171   2                              
 172   2                              break;
 173   2      
 174   2                              
 175   2              }
 176   1      
 177   1      }
C51 COMPILER V9.00   APP                                                                   11/10/2013 13:25:21 PAGE 4   

 178          
 179          // 按键处理
 180          void keyProcess()
 181          {
 182   1              static uint16 keyTime = 0;
 183   1              static bit keyLock = 0;
 184   1              if(KEY == KEY_PRESSED)
 185   1              {
 186   2                      keyTime++;
 187   2                      if(keyTime >= 1000 && keyLock == 0)
 188   2                      {
 189   3                              ledMode++;
 190   3                              if(ledMode > LED_MODE_NUM - 1)
 191   3                              {
 192   4                                      ledMode = 0;
 193   4                                      P2 = 0x00;
 194   4                              }
 195   3                              keyLock = 1;
 196   3                      }
 197   2              }
 198   1              if(keyTime > 2000)
 199   1              {
 200   2                      if(KEY != KEY_PRESSED)
 201   2                      {
 202   3                              keyTime = 0;
 203   3                              keyLock = 0;
 204   3                      }
 205   2              }
 206   1      }
 207                  
 208          void ledTimeUpdate() interrupt 1 using 1
 209          {
 210   1              uint8 i;
 211   1              for(i = 0; i <= 7; i++)
 212   1              {
 213   2                      if(ledTime[i] != 0)
 214   2                      {
 215   3                              ledTime[i] = ledTime[i] + 1;
 216   3                              if(ledTime[i] >= 260)
 217   3                              {
 218   4                                      ledTime[i] = 0;
 219   4                                      P2 &= 0xfe << i;
 220   4                              }
 221   3                      }
 222   2              }
 223   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1040    ----
   CONSTANT SIZE    =     65    ----
   XDATA SIZE       =     43       3
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  1 WARNING(S),  0 ERROR(S)
