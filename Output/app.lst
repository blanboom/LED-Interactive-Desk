C51 COMPILER V9.51   APP                                                                   10/27/2013 12:40:15 PAGE 1   


C51 COMPILER V9.51, COMPILATION OF MODULE APP
OBJECT MODULE PLACED IN .\Output\app.obj
COMPILER INVOKED BY: C:\Program Files (x86)\Keil\C51\BIN\C51.EXE Code\app.c LARGE BROWSE DEBUG OBJECTEXTEND PRINT(.\Outp
                    -ut\app.lst) TABS(2) OBJECT(.\Output\app.obj)

line level    source

   1          #include "app.h"
   2          #include "stc15.h"
   3          #include "system.h"
   4          #include <stdio.h>
   5          
   6          uint8 pwmTime[8] = {0, 0, 0, 0, 0, 0, 0, 0};   // PWM 计时
   7          uint8 ledMode = 0;      // LED 模式
   8          uint16 ledTime[8] = {0, 0, 0, 0, 0, 0, 0, 0};    // LED 时间，0 为未启动
   9          
  10          uint16 blinkCounter[8] = {0, 0, 0, 0, 0, 0, 0, 0};   
  11          
  12          void init()
  13          {
  14   1        initUart();
  15   1        initADC();
  16   1        
  17   1        KEY = !KEY_PRESSED;
  18   1        P2 = 0x00;
  19   1        P2M0 = 0xff;
  20   1        P2M1 = 0x00;
  21   1        
  22   1        // 初始化 LED 计时器（定时器 0）
  23   1        AUXR |= 0x80;  // 定时器 0：1T 模式
  24   1        TMOD = 0x03;   // 定时器 0 模式 3
  25   1        TL0 = T20MS;   // 装入时间：20ms
  26   1        TH0 = T20MS >> 8;
  27   1        TR0 = 1;       // 开始计时
  28   1        ET0 = 1;       // 使能定时器 0 在模式 3 下的中断
  29   1        
  30   1        
  31   1        printf("LED Interactive Desk\nby xiao3d and Blanboom\nhttp://blanboom.org\n");
  32   1      }
  33          
  34          // 启动 LED
  35          void lightUp(pin)
  36          {
  37   1        uint8 result;
  38   1        P1 = 0x01 << pin;
  39   1        result = getADCResult(pin);
  40   1        if (result > 50)
  41   1        {
  42   2          ledTime[pin] = 1;
  43   2        }
  44   1      }
  45          
  46          // LED 的 PWM 控制程序
  47          void ledPWM(uint8 pin, uint8 brightness)
  48          {
  49   1        pwmTime[pin] = pwmTime[pin] + 1;
  50   1        if(pwmTime[pin] >= 20)
  51   1        {
  52   2          pwmTime[pin] = 0;
  53   2        }
  54   1        if(pwmTime[pin] <= brightness)
C51 COMPILER V9.51   APP                                                                   10/27/2013 12:40:15 PAGE 2   

  55   1        {
  56   2          P2 |= 0x01 << pin;
  57   2        }
  58   1        if(pwmTime[pin] > brightness)
  59   1        {
  60   2          P2 &= 0xfe << pin;
  61   2        }
  62   1      }
  63          
  64          // LED 闪烁
  65          void ledBlink(pin)
  66          {
  67   1        blinkCounter[pin] = blinkCounter[pin] + 1;
  68   1        if(blinkCounter[pin] == 100)
  69   1        {
  70   2          P2 |= 0x01 << pin;
  71   2        }
  72   1        if(blinkCounter[pin] == 112)
  73   1        {
  74   2          P2 &= 0xfe << pin;
  75   2        }
  76   1        if(blinkCounter[pin] >= 200)
  77   1        {
  78   2          blinkCounter[pin] = 0;
  79   2        }
  80   1      }
  81            
  82          // LED 处理
  83          // 到达指定的时间调节 LED 亮度
  84          void ledProcess(uint8 pin)
  85          {
*** WARNING C235 IN LINE 85 OF Code\app.c: parameter 1: different types
  86   1        switch (ledMode)
  87   1        {   
  88   2          
  89   2        case 0 :
  90   2            // 渐变
  91   2            if(ledTime[pin] != 0)
  92   2            {
  93   3              ledPWM(pin, (260-ledTime[pin]) / 13);
  94   3            }
  95   2            break;
  96   2            
  97   2        case 1:
  98   2            // 灯亮一定时间后灭
  99   2            if(ledTime[pin] != 0)
 100   2            {
 101   3              P2 |= 0x01 << pin;
 102   3            }
 103   2            break;
 104   2            
 105   2        case 2:
 106   2            // 快速闪烁
 107   2            if(ledTime[pin] != 0)
 108   2            {
 109   3              ledBlink(pin);
 110   3            }
 111   2            break;
 112   2            
 113   2        case 3:
 114   2            // 手放上去灯灭
 115   2            if(ledTime[pin] == 0)
C51 COMPILER V9.51   APP                                                                   10/27/2013 12:40:15 PAGE 3   

 116   2            {
 117   3              P2 |= 0x01 << pin;
 118   3            }
 119   2            else
 120   2            {
 121   3              P2 &= 0xfe << pin;
 122   3            }
 123   2        }
 124   1      
 125   1      }
 126          
 127          // 按键处理
 128          void keyProcess()
 129          {
 130   1        static uint16 keyTime = 0;
 131   1        static bit keyLock = 0;
 132   1        if(KEY == KEY_PRESSED)
 133   1        {
 134   2          keyTime++;
 135   2          if(keyTime <= 200 && keyLock == 0)
 136   2          {
 137   3            ledMode++;
 138   3            if(ledMode > LED_MODE_NUM - 1)
 139   3            {
 140   4              ledMode = 0;
 141   4            }
 142   3            keyLock = 1;
 143   3          }
 144   2        }
 145   1        if(keyTime > 200)
 146   1        {
 147   2          if(KEY != KEY_PRESSED)
 148   2          {
 149   3            keyTime = 0;
 150   3            keyLock = 0;
 151   3          }
 152   2        }
 153   1      }
 154            
 155          void ledTimeUpdate() interrupt 1 using 1
 156          {
 157   1        uint8 i;
 158   1        for(i = 0; i <= 7; i++)
 159   1        {
 160   2          if(ledTime[i] != 0)
 161   2          {
 162   3            ledTime[i] = ledTime[i] + 1;
 163   3            if(ledTime[i] >= 260)
 164   3            {
 165   4              ledTime[i] = 0;
 166   4              P2 &= 0xfe << i;
 167   4            }
 168   3          }
 169   2        }
 170   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    707    ----
   CONSTANT SIZE    =     65    ----
   XDATA SIZE       =     43       3
   PDATA SIZE       =   ----    ----
C51 COMPILER V9.51   APP                                                                   10/27/2013 12:40:15 PAGE 4   

   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  1 WARNING(S),  0 ERROR(S)
